#! /bin/sh
. ../.bash_aliases
cd $HOME/b2d/gitolite
./build $1
cd $HOME/b2d/openldap
./run $1
cd $HOME/b2d/apache

if [ "${1}" == "bash" ]; then
	docker run -it --rm --volumes-from gitolite.repos.cont --volumes-from gitolite.cont apache bash
	exit 0
fi

apache_cont="apache.cont"
apache_openldap_cont="apache.openldap.cont"
gitolite_cont="gitolite.cont"
gitolite_repos_cont="gitolite.repos.cont"
envs_cnf="envs.cnf"

if [ "${1}" != "" ]; then
	apache_cont="apache.${1}.cont"
	gitolite_cont="gitolite.${1}.cont"
	gitolite_repos_cont="gitolite.repos.${1}.cont"
	envs_cnf="envs.${1}.cnf"
fi

port_gitweb=$(sed -n "s#^\s*@PORT_HTTP_GITWEB@\s*=\s*##p" ../${envs_cnf})
if [ "${port_gitweb}" == "" ]; then echo "missing @PORT_HTTP_GITWEB@ in '$HOME/b2d/${envs_cnf}'"; exit 0; fi
port_hgit=$(sed -n "s#^\s*@PORT_HTTP_HGIT@\s*=\s*##p" ../${envs_cnf})
if [ "${port_hgit}" == "" ]; then echo "missing @PORT_HTTP_HGIT@ in '$HOME/b2d/${envs_cnf}'"; exit 0; fi

echo "docker run -it -d --name ${apache_cont} -p ${port_gitweb}:8543 -p ${port_hgit}:8553 --link openldap.cont:apache.openldap.cont --volumes-from ${gitolite_repos_cont} --volumes-from ${gitolite_cont} apache"

docker inspect ${apache_cont} > /dev/null 2>&1 || docker run -it -d --name ${apache_cont} -p ${port_gitweb}:8543 -p ${port_hgit}:8553 --link openldap.cont:apache.openldap.cont --volumes-from ${gitolite_repos_cont} --volumes-from ${gitolite_cont} apache
