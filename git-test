#!/bin/sh
# http://stackoverflow.com/questions/64786/error-handling-in-bash
set -o pipefail  # trace ERR through pipes
# set -o errtrace  # trace ERR through 'time command' and other functions
set -o nounset   ## set -u : exit the script if you try to use an uninitialised variable
set -o errexit   ## set -e : exit the script if any statement returns a non-true return value
. ./colors.sh
dirp0=$(readlink -f "$(dirname $0)")
stepp() {
	set +e; steppres="$(grep ${1} tests/steps| tr -d '\n')"; set -e
	# echo "steppres='${steppres}'aa"
	return 0
}

spaces=""
setSpaces() {
	if [ ${ii} -gt 0 ]; then spaces="  "; fi
}

title() {
	m="${1}"
	nl=""
	if [ "${m#_}" != "${m}" ]; then m="${m#_}"; nl="1"; fi
	# echo "nl='${nl}', m='${m}'"
	m="${spaces}${env}.${i}: ${m}"
	if [ "${nl}" != "" ]; then echo -ne "${m} "; else echo -e "${m}"; fi
}


cmd() {
	c="${1}"
	cp="${c%%://*}://"
	c=${c#${cp}}
	cu="${c%%@*}"
	c="${cp}${cu}:${c}"
	# echo "cp='${cp}', c='${c}', cu='${cu}'"
	if [ "${cu}" = "" ]; then c="${1}"; fi
	m="${1#g }"
	m="${gg} ${m}"
	c="${c#g }"
	c="${gg} ${c}"
	m="${spaces}${m}"
	echo -e "${Cyan}${m}${Color_Off}"
	set +e
	o=$(${c} 2> tests/err 1> tests/out) ; r=$?
	if [ "$(ls -l tests/out 2> /dev/null | awk '{print $5}')" != "0" ]; then
		while read line; do    
    		echo -e "${Green}${line}${Color_Off}"   
		done < tests/out
	fi
	if [ "$(ls -l tests/err 2> /dev/null | awk '{print $5}')" != "0" ]; then
		if [ $r -eq 0 ]; then p="${Green}    "; else p="${Red}    "; fi
		while read line; do    
    		echo -e "${p}${line}${Color_Off}"   
		done < tests/err
	fi
	# cmd /C "set force_res=1 && t"
	forced=""
	set +u; if [ ! -z "${force_res}" ] && [ ! -z "${2}" ]; then
		e=$(grep "${2}" tests/err)
		if [ "${e}" != "" ]; then r=0; forced="forced"; fi
	fi; set -u
	set -e
	return $r
}

stepcmd() {
	atitle="${1}"
	acode="${2}"
	acmd="${3}"
	acmderr="${4}"

	ii=$((ii+1)); setSpaces
	title "${atitle}"
	stepp "${acode}"
	# echo "steppres='${steppres#${acode}}'aa"
	if [ "${steppres}" != "${acode}" ]; then
		echo ""
		cmd "${acmd}" "${acmderr}"
		if [ "${forced}" == "" ]; then echo -e "${spaces}${Green}[done]${Color_Off}";
		else echo -e "${spaces}${Green}[forced]${Color_Off}"; fi
		if [ "${steppres}" == "" ]; then echo "${acode}">> tests/steps; fi
	else echo -e "${Green}(already done)${Color_Off}"; fi
}
git -c http.sslCAInfo=apache/crts --version
gg="git -c http.sslCAInfo=${dirp0}/apache/crts"
alias g=${gg}
alias g
export LOG_LEVEL=3
steppres=""
touch tests/steps
i=1
ii=0
env="B"
echo -e "${Black}${On_White}Git Servers tests${Color_Off}"
echo -e "${Black}${On_White}=================${Color_Off}"
echo ""
echo -e "${Black}${On_Yellow}B: Blessed tests${Color_Off}"
if [ ! -e "tests/blessed" ]; then mkdir -p tests/blessed; fi
echo -e "${Black}${On_Yellow}   -------------${Color_Off}"
title "gitolite-admin repo"
stepcmd "_clone blessed gitolite-admin in tests/blessed/gitolite-admin" \
		"B_gitolite-admin_cloned" \
		"g clone https://gitoliteadm@localhost:6443/hgit/gitolite-admin tests/blessed/gitolite-admin" \
		"already exists and is not an empty directory"
stepcmd "_check ls-remote in tests/blessed/gitolite-admin" \
		"B_gitolite-admin_ls-remote" \
		"g -C tests/blessed/gitolite-admin ls-remote https://gitoliteadm@localhost:6443/hgit/gitolite-admin" \
		"xxx"
stepcmd "_(master) Add projextrdr to all repo" \
		"B_gitolite-admin_master_add_projextrdr" \
		"master_add_projextrdr_to_all_repos" \
		"___add projextrdr to all repo"
echo -e "${Green}[v] all done${Color_Off}"
